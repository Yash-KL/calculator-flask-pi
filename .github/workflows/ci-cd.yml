name: Multi-Environment CI/CD

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build Docker image
        run: docker build -t ghcr.io/${{ github.repository_owner }}/calculator-flask:latest .

      - name: Push Docker image
        run: docker push ghcr.io/${{ github.repository_owner }}/calculator-flask:latest

  deploy-qa:
    runs-on: self-hosted
    needs: build
    environment: QA
    steps:
      - name: Deploy to QA
        run: |
          IMAGE="ghcr.io/${{ github.repository_owner }}/calculator-flask:latest"
          echo "Using image: $IMAGE"
          docker pull $IMAGE
          docker stop calculator-flask-qa || true
          docker rm calculator-flask-qa || true
          docker run -d --name calculator-flask-qa -p 5000:5000 $IMAGE

  deploy-staging:
    runs-on: self-hosted
    needs: deploy-qa
    environment: staging
    steps:
      - name: Deploy to Staging
        run: |
          IMAGE="ghcr.io/${{ github.repository_owner }}/calculator-flask:latest"
          echo "Using image: $IMAGE"
          docker pull $IMAGE
          docker stop calculator-flask-staging || true
          docker rm calculator-flask-staging || true
          docker run -d --name calculator-flask-staging -p 5001:5000 $IMAGE

  deploy-production:
    runs-on: self-hosted
    needs: deploy-staging
    environment: production
    steps:
      - name: Deploy to Production
        run: |
          IMAGE="ghcr.io/${{ github.repository_owner }}/calculator-flask:latest"
          echo "Using image: $IMAGE"
          docker pull $IMAGE
          docker stop calculator-flask-prod || true
          docker rm calculator-flask-prod || true
          docker run -d --name calculator-flask-prod -p 5002:5000 $IMAGE
