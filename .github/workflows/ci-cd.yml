name: CI-CD

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: self-hosted
    outputs:
      owner_lc: ${{ steps.set_owner.outputs.owner_lc }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 1: Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Step 2: Log in to GitHub Container Registry
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Step 3: Set lowercase repo owner and create a job output
      - name: Set lowercase owner
        id: set_owner
        run: |
          echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV
          echo "owner_lc=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_OUTPUT

      # Step 4: Build & Push Docker image
      - name: Build and Push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/arm64
          tags: ghcr.io/${{ env.OWNER_LC }}/calculator-flask:latest

  deploy-qa:
    runs-on: self-hosted
    needs: build
    environment: QA
    steps:
      - name: Deploy QA Container
        run: |
          IMAGE="ghcr.io/${{ needs.build.outputs.owner_lc }}/calculator-flask:latest"
          echo "Deploying $IMAGE"
          docker pull $IMAGE
          docker stop calculator-flask-qa || true
          docker rm calculator-flask-qa || true
          docker run -d --name calculator-flask-qa -p 3000:5000 $IMAGE

  deploy-staging:
    runs-on: self-hosted
    needs: build # Change this to depend on 'build'
    environment: Staging
    steps:
      - name: Deploy Staging Container
        run: |
          IMAGE="ghcr.io/${{ needs.build.outputs.owner_lc }}/calculator-flask:latest"
          docker pull $IMAGE
          docker stop calculator-flask-staging || true
          docker rm calculator-flask-staging || true
          docker run -d --name calculator-flask-staging -p 4000:5000 $IMAGE

  deploy-production:
    runs-on: self-hosted
    needs: deploy-staging # This dependency is fine to keep
    environment: Production
    steps:
      - name: Deploy Production Container
        run: |
          IMAGE="ghcr.io/${{ needs.build.outputs.owner_lc }}/calculator-flask:latest"
          docker pull $IMAGE
          docker stop calculator-flask-prod || true
          docker rm calculator-flask-prod || true
          docker run -d --name calculator-flask-prod -p 5000:5000 $IMAGE

