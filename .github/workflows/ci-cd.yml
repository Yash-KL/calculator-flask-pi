name: CI + Deploy to Pi 50

on:
  push:
    branches: [ "main" ]

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies & run tests
        run: |
          pip install -r requirements.txt
          pytest -q

      - name: Docker build and push to GHCR
        run: |
          REPO_OWNER=$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')
          IMAGE="ghcr.io/${REPO_OWNER}/calculator-flask:latest"
          echo "Building and pushing $IMAGE"
          docker buildx build --platform linux/arm64 -t $IMAGE --push .

  deploy:
    needs: build-test
    runs-on: [self-hosted, Linux, ARM64, pi-runner]  # Runner on Pi 1.51
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Deploy to Pi 1 (192.168.1.50)
        env:
          PI_HOST: ${{ secrets.PI50_HOST }}
          PI_USER: ${{ secrets.PI50_USER }}
        run: |
          echo "${{ secrets.PI50_SSH_KEY }}" > pi50_key
          chmod 600 pi50_key

          ssh -o StrictHostKeyChecking=no -i pi50_key $PI_USER@$PI_HOST "mkdir -p ~/calc"

          # Copy docker-compose.yml
          scp -o StrictHostKeyChecking=no -i pi50_key docker-compose.yml $PI_USER@$PI_HOST:~/calc/

          # Deploy
          ssh -o StrictHostKeyChecking=no -i pi50_key $PI_USER@$PI_HOST "
            cd ~/calc && \
            docker compose pull && \
            docker compose up -d && \
            docker image prune -f
          "
